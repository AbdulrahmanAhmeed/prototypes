<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="IPCameraViewer.MainPage"
             Title="IP Camera Viewer - Multi Stream">

    <Grid RowDefinitions="Auto,*,Auto" Padding="20" RowSpacing="15">

        <!-- Add Stream Section -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">
            <Label Text="Add Camera Stream:" 
                   FontAttributes="Bold"
                   FontSize="18"
                   VerticalOptions="Center"/>

            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                <Entry x:Name="CameraUrlEntry"
                       Placeholder="http://camera-url/stream"
                       Text="http://220.233.144.165:8888/mjpg/video.mjpg"
                       FontSize="16"/>

                <Entry x:Name="CameraNameEntry"
                       Grid.Column="1"
                       Placeholder="Camera Name"
                       WidthRequest="150"
                       FontSize="16"/>

                <Button Grid.Column="2"
                        Text="Add Stream"
                        Clicked="OnAddStreamClicked"
                        WidthRequest="120"/>
            </Grid>

            <HorizontalStackLayout Spacing="10">
                <Button Text="Stop All Streams" Clicked="OnStopAllClicked"/>
                <Button Text="Clear All Logs" Clicked="OnClearAllLogsClicked"/>
            </HorizontalStackLayout>
        </VerticalStackLayout>

        <!-- Streams Display -->
        <ScrollView Grid.Row="1">
            <CollectionView x:Name="StreamsCollection"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Stroke="LightGray"
                                StrokeThickness="2"
                                Padding="10"
                                Margin="0,0,0,15"
                                BackgroundColor="Black">
                            <VerticalStackLayout Spacing="10">

                                <!-- Header with Camera Name and Controls -->
                                <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                                    <Label Text="{Binding CameraName}"
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           TextColor="White"
                                           VerticalOptions="Center"/>

                                    <Button Grid.Column="1"
                                            Text="Remove"
                                            Clicked="OnRemoveStreamClicked"
                                            CommandParameter="{Binding Id}"
                                            WidthRequest="100"
                                            BackgroundColor="OrangeRed"
                                            TextColor="White"/>

                                    <Button Grid.Column="2"
                                            Text="{Binding IsRunning, Converter={StaticResource BoolToStartStopConverter}}"
                                            Clicked="OnToggleStreamClicked"
                                            CommandParameter="{Binding Id}"
                                            WidthRequest="100"/>
                                </Grid>

                                <Label Text="{Binding Url}"
                                       FontSize="12"
                                       TextColor="LightGray"/>

                                <!-- Stream Content -->
                                <Grid ColumnDefinitions="*,300">
                                    <Image Source="{Binding CurrentFrame}"
                                           HeightRequest="300"
                                           WidthRequest="400"
                                           Aspect="AspectFit"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>

                                    <VerticalStackLayout Grid.Column="1" Spacing="8" Padding="10,0,0,0">
                                        <Label Text="Detections" FontAttributes="Bold" TextColor="White"/>
                                        <CollectionView ItemsSource="{Binding DetectionLogs}"
                                                        HeightRequest="200"
                                                        SelectionMode="None">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Label Text="{Binding .}" FontSize="11" TextColor="LightGray"/>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                        <Button Text="Clear Logs" 
                                                Clicked="OnClearStreamLogsClicked"
                                                CommandParameter="{Binding Id}"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <!-- Motion Threshold Slider -->
                                <VerticalStackLayout Spacing="5">
                                    <Label Text="{Binding MotionThresholdPercent, StringFormat='Motion Threshold: {0:F1}%'}"
                                           FontSize="13"
                                           TextColor="White"/>
                                    <Slider Minimum="0.1"
                                            Maximum="100"
                                            Value="{Binding MotionThresholdPercent}"
                                            ValueChanged="OnThresholdChanged"/>
                                </VerticalStackLayout>

                                <!-- Sound Settings -->
                                <Border Stroke="DarkGray"
                                        StrokeThickness="1"
                                        Padding="10"
                                        BackgroundColor="#1A1A1A">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Sound Settings"
                                               FontAttributes="Bold"
                                               FontSize="14"
                                               TextColor="White"/>
                                        
                                        <!-- Enable Sound Toggle -->
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                            <Label Text="Enable Sound Alerts"
                                                   FontSize="13"
                                                   TextColor="White"
                                                   VerticalOptions="Center"/>
                                            <Switch Grid.Column="1"
                                                    IsToggled="{Binding SoundEnabled}"
                                                    Toggled="OnSoundEnabledToggled"/>
                                        </Grid>

                                        <!-- Sound File Selection -->
                                        <VerticalStackLayout Spacing="5">
                                            <Label Text="Sound File:"
                                                   FontSize="13"
                                                   TextColor="White"/>
                                            <Label Text="{Binding SoundFileName}"
                                                   FontSize="12"
                                                   TextColor="LightGray"
                                                   LineBreakMode="TailTruncation"/>
                                            <Grid ColumnDefinitions="*,*" ColumnSpacing="5">
                                                <Button Grid.Column="0"
                                                        Text="Select File"
                                                        Clicked="OnSelectSoundFileClicked"
                                                        CommandParameter="{Binding Id}"
                                                        FontSize="12"
                                                        Padding="5"/>
                                                <Button Grid.Column="1"
                                                        Text="Clear"
                                                        Clicked="OnClearSoundFileClicked"
                                                        CommandParameter="{Binding Id}"
                                                        FontSize="12"
                                                        Padding="5"
                                                        BackgroundColor="OrangeRed"
                                                        TextColor="White"/>
                                            </Grid>
                                            <Button Text="Test Sound"
                                                    Clicked="OnTestSoundClicked"
                                                    CommandParameter="{Binding Id}"
                                                    FontSize="12"
                                                    Padding="5"
                                                    BackgroundColor="Green"
                                                    TextColor="White"
                                                    IsEnabled="{Binding SoundEnabled}"/>
                                        </VerticalStackLayout>

                                        <!-- Sound Volume Slider -->
                                        <VerticalStackLayout Spacing="5">
                                            <Label Text="{Binding SoundVolume, StringFormat='Volume: {0:P0}'}"
                                                   FontSize="13"
                                                   TextColor="White"/>
                                            <Slider Minimum="0"
                                                    Maximum="1"
                                                    Value="{Binding SoundVolume}"
                                                    ValueChanged="OnVolumeChanged"/>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </Border>

                                <!-- Recording Settings -->
                                <Border Stroke="DarkGray"
                                        StrokeThickness="1"
                                        Padding="10"
                                        BackgroundColor="#1A1A1A">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Recording Settings"
                                               FontAttributes="Bold"
                                               FontSize="14"
                                               TextColor="White"/>
                                        
                                        <!-- Enable Recording Toggle -->
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                            <Label Text="Enable Recording"
                                                   FontSize="13"
                                                   TextColor="White"
                                                   VerticalOptions="Center"/>
                                            <Switch Grid.Column="1"
                                                    IsToggled="{Binding RecordingEnabled}"
                                                    Toggled="OnRecordingEnabledToggled"/>
                                        </Grid>

                                        <!-- Output Formats -->
                                        <VerticalStackLayout Spacing="5" IsVisible="{Binding RecordingEnabled}">
                                            <Label Text="Output Formats:"
                                                   FontSize="13"
                                                   TextColor="White"/>
                                            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                                <CheckBox Grid.Column="0"
                                                          IsChecked="{Binding RecordingGif}"
                                                          CheckedChanged="OnRecordingFormatChanged"/>
                                                <Label Grid.Column="0"
                                                       Text="GIF"
                                                       FontSize="12"
                                                       TextColor="White"
                                                       VerticalOptions="Center"
                                                       Margin="25,0,0,0"/>

                                                <CheckBox Grid.Column="1"
                                                          IsChecked="{Binding RecordingPng}"
                                                          CheckedChanged="OnRecordingFormatChanged"/>
                                                <Label Grid.Column="1"
                                                       Text="PNG"
                                                       FontSize="12"
                                                       TextColor="White"
                                                       VerticalOptions="Center"
                                                       Margin="25,0,0,0"/>
                                            </Grid>
                                            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                                <CheckBox Grid.Column="0"
                                                          IsChecked="{Binding RecordingMp4}"
                                                          CheckedChanged="OnRecordingFormatChanged"/>
                                                <Label Grid.Column="0"
                                                       Text="MP4"
                                                       FontSize="12"
                                                       TextColor="White"
                                                       VerticalOptions="Center"
                                                       Margin="25,0,0,0"/>
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!-- Output Path -->
                                        <VerticalStackLayout Spacing="5" IsVisible="{Binding RecordingEnabled}">
                                            <Label Text="Output Path:"
                                                   FontSize="13"
                                                   TextColor="White"/>
                                            <Label Text="{Binding RecordingOutputPath, StringFormat='{0}'}"
                                                   FontSize="11"
                                                   TextColor="LightGray"
                                                   LineBreakMode="TailTruncation"/>
                                            <Button Text="Select Output Folder"
                                                    Clicked="OnSelectOutputFolderClicked"
                                                    CommandParameter="{Binding Id}"
                                                    FontSize="12"
                                                    Padding="5"/>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </Border>

                                <!-- Metrics -->
                                <HorizontalStackLayout Spacing="20">
                                    <Label Text="{Binding Metrics}"
                                           FontSize="13"
                                           TextColor="White"/>
                                    <Label Text="{Binding MotionStatus}"
                                           TextColor="{Binding MotionColor}"
                                           FontAttributes="Bold"
                                           FontSize="13"/>
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>

        <!-- Status Bar -->
        <Label Grid.Row="2"
               x:Name="StatusLabel"
               Text="Ready"
               FontSize="14"
               TextColor="Gray"
               HorizontalOptions="Center"/>
    </Grid>
</ContentPage>